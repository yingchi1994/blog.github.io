<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Linux Netfilter/iptables 学习</title>
  <meta name="author" content="YINGCHI_Joey" />
  <meta name="description"
        content="Linux 网络协议栈非常高效，同时比较复杂。如果我们希望在数据的处理过程中对关心的数据进行一些操作，则该怎么做呢？Linux 提供了一套机制来为用户实现自定义的数据包处理过程。在 Linux 网络协议栈中有一组回调函数挂接点，通过这些挂接点挂接的钩子函数可以在 Linux 网络栈处理数据包的过程中对数据包进行一些操作，例如过滤、修改、丢弃等。整个挂接点技术叫作 Netfilter..."/>


  <meta name="generator" content="Hugo 0.71.1" />

  
  <meta itemprop="name" content="Linux Netfilter/iptables 学习"/>
  <meta itemprop="description"
        content="Linux 网络协议栈非常高效，同时比较复杂。如果我们希望在数据的处理过程中对关心的数据进行一些操作，则该怎么做呢？Linux 提供了一套机制来为用户实现自定义的数据包处理过程。在 Linux 网络协议栈中有一组回调函数挂接点，通过这些挂接点挂接的钩子函数可以在 Linux 网络栈处理数据包的过程中对数据包进行一些操作，例如过滤、修改、丢弃等。整个挂接点技术叫作 Netfilter..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Linux Netfilter/iptables 学习"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="https://blog.yingchi.io/posts/2020/5/linux-iptables.html"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Linux 网络协议栈非常高效，同时比较复杂。如果我们希望在数据的处理过程中对关心的数据进行一些操作，则该怎么做呢？Linux 提供了一套机制来为用户实现自定义的数据包处理过程。在 Linux 网络协议栈中有一组回调函数挂接点，通过这些挂接点挂接的钩子函数可以在 Linux 网络栈处理数据包的过程中对数据包进行一些操作，例如过滤、修改、丢弃等。整个挂接点技术叫作 Netfilter..."/>
  <meta property="og:site_name" content="Yingchi Blog"/>
  <meta property="article:published_time"
        content="2020-05-14T17:35:21&#43;08:00"/>
  <meta property="article:section" content="posts"/>
  <meta property="article:tag" content="kubernetes"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Linux Netfilter/iptables 学习"/>
  <meta name="twitter:description"
        content="Linux 网络协议栈非常高效，同时比较复杂。如果我们希望在数据的处理过程中对关心的数据进行一些操作，则该怎么做呢？Linux 提供了一套机制来为用户实现自定义的数据包处理过程。在 Linux 网络协议栈中有一组回调函数挂接点，通过这些挂接点挂接的钩子函数可以在 Linux 网络栈处理数据包的过程中对数据包进行一些操作，例如过滤、修改、丢弃等。整个挂接点技术叫作 Netfilter..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content=""/>

  

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  

  
  
  
  
  <script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500724862");

  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>
</head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <section>
  <nav style="text-align: center; margin-top: 30px;">
    <div>
        <a class="custom-title" href="/">
          
          <img class="logo" src="/logo.png"/>
        </a>
    </div>
  </nav>

</section>

<style>
  .custom-title{
    color: rgb(87, 87, 87);
    font-size: 25px;
    font-weight: bold;
    text-decoration: none;
  }

  .logo{
    width: 190px;
  }
</style>

    <section class="section" style="flex:1">

      
      <div class="container">
        
        <p class="title-custom">Linux Netfilter/iptables 学习</p>
        <p class="subtitle-custom">May 14, 2020</p>

        

        
        
        <div class="content-custom">
          <p>Linux 网络协议栈非常高效，同时比较复杂。如果我们希望在数据的处理过程中对关心的数据进行一些操作，则该怎么做呢？Linux 提供了一套机制来为用户实现自定义的数据包处理过程。在 Linux 网络协议栈中有一组回调函数挂接点，通过这些挂接点挂接的钩子函数可以在 Linux 网络栈处理数据包的过程中对数据包进行一些操作，例如过滤、修改、丢弃等。整个挂接点技术叫作 Netfilter 和 iptables。</p>
<p>Netfilter 与 iptables 不是两个独立的组件，Netfilter 是一个位于内核空间的防火墙框架，而 iptables 可以认为是一个位于用户空间的客户端。</p>
<p>Netfilter 的核心功能就是<strong>数据包过滤</strong>、<strong>数据包修改</strong>、<strong>网络地址转换（NAT）</strong></p>
<h2 id="基础概念">基础概念</h2>
<h3 id="规则概念">规则概念</h3>
<p>iptables 最核心的概念是 Rules，即规则，一句话概括其工作逻辑就是“<strong>对于匹配到规则的数据包执行预先指定好的逻辑</strong>”。这里涉及到几个概念，首先是匹配，从字面上很好理解，匹配就是看对不对的上号，对于 iptables 而言，它面对的是数据包，因此它要匹配的自然是与数据包相关的信息，比如源地址、目的地址、传输协议、服务类型，只有当这些可以匹配的时候，才执行一些规则逻辑，比如放行、拒绝、丢弃等。</p>
<h3 id="五链">五链</h3>
<p>或许你对 iptables 具体是做什么的，怎么工作的并不熟悉，但是当你听到一个内行来讲 iptables 的时候，他一定会提到“四表五链”，那么什么是 iptables 的四表无链？他们又有什么作用呢？</p>
<p>首先说“链”，这里的链指的是“规则链”，即在 iptables 的工作过程中，并不是只通过一条规则来处理数据包的，而是有许多规则，这些规则按照一定的顺序排列起来，报文经过 iptables 时就要对着一些规则一条一条进行匹配，执行相应的动作，我们把这种一系列的规则看作是一种串联，则称为是“链”。</p>
<p>比如以其中一条称作 PREROUTING 的链来看，它的内部结构是这样的：</p>
<p><img src="linux-iptables/image-20200713001653413.png" alt="image-20200713001653413"></p>
<p>数据包会在这条链里经过很多条的规则匹配，如果该数据包不符合链中任一条规则，iptables就会根据预先定义的默认策略来处理数据包。</p>
<p>在 iptables 中存在着如下五条链：</p>
<p><img src="linux-iptables/image-20200713000735547.png" alt="image-20200713000735547"></p>
<ul>
<li><strong>PREROUTING 链</strong>：路由选择前；</li>
<li><strong>INPUT 链</strong>：路由目的地为本机；</li>
<li><strong>FORWARD 链</strong>：路由目的地非本机，转发；</li>
<li><strong>OUTPUT 链</strong>：本机发出数据包；</li>
<li><strong>POSTROUTING 链</strong>：路由选择后；</li>
</ul>
<h3 id="四表">四表</h3>
<p>知道了五链之后，接下来看四表，如果说链是表现的是一系列规则的执行顺序关系，那么表则是表现的一系列规则的功能逻辑关系，我们<strong>把具有相同功能的规则集合称为“表”</strong>，因为我们会发现有时在不同的链上执行的规则它们之间是有内在关联的，或是对数据的过滤，或是对报文数据的修改等等，iptables 为我们提供了如下的规则分类：</p>
<ul>
<li><strong>Filter 表</strong>：iptables 默认表，负责包过滤，防火墙功能；</li>
<li><strong>NAT 表</strong>：负责网络地址转换功能，对应内核模块；</li>
<li><strong>Mangle 表</strong>：主要负责修改数据包，对应内核模块；</li>
<li><strong>Raw 表</strong>：优先级最高，关闭 NAT 表启用的连接追踪机制；</li>
</ul>
<p>注意这些表是有优先级之分的，优先级高到低：<strong>raw&ndash;&gt;mangle&ndash;&gt;nat&ndash;&gt;filter</strong></p>
<p>链与表的对应也不是随随便便的，有些表的规则只有对应链上可能存在，具体的<strong>链表对应关系</strong>如下：：</p>
<p>PREROUTING 链：raw表，mangle表，nat表。</p>
<p>INPUT 链：mangle表，filter表，（centos7中还可以有nat表）</p>
<p>FORWARD 链：mangle表，filter表。</p>
<p>OUTPUT 链：raw表mangle表，nat表，filter表。</p>
<p>POSTROUTING 链：mangle表，nat表。</p>
<p><img src="linux-iptables/image-20200713005027957.png" alt="image-20200713005027957"></p>
<h3 id="再看规则">再看规则</h3>
<p>一开始只是提到了规则这个概念，那么规则的匹配和规则逻辑该如何定义和进行呢？</p>
<h4 id="匹配条件">匹配条件</h4>
<p>分为<strong>基本匹配条件</strong>和<strong>扩展匹配条件</strong></p>
<ul>
<li>基本匹配条件：源 IP，目标 IP；</li>
<li>扩展匹配条件：除了上述的条件可以用于匹配，还有很多其他的条件可以用于匹配，这些条件泛称为扩展条件，如源端口，目的端口等；</li>
</ul>
<h4 id="规则逻辑">规则逻辑</h4>
<p>规则逻辑在 iptables 中称为 <strong>target</strong>，常见的一些处理逻辑如下：</p>
<ul>
<li>
<p><strong>ACCEPT</strong>：允许数据包通过；</p>
</li>
<li>
<p><strong>DROP</strong>：直接丢弃数据包；</p>
</li>
<li>
<p><strong>REJECT</strong>：拒绝数据包；</p>
</li>
<li>
<p><strong>SNAT</strong>：源地址转换，可以解决内网用户用同一个公网地址上网的问题；</p>
</li>
<li>
<p><strong>DNAT</strong>：目标地址转换；</p>
</li>
<li>
<p><strong>MASQUERADE</strong>：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上；</p>
</li>
<li>
<p><strong>REDIRECT</strong>：在本机做端口映射；</p>
</li>
<li>
<p><strong>MARK</strong>：数据包打标记；</p>
</li>
</ul>
<p>注意：</p>
<ol>
<li>目标地址转换一般在 PREROUTING 链上操作</li>
<li>源地址转换一般在 POSTROUTING 链上操作</li>
</ol>
<h2 id="总结">总结</h2>
<p>1、当主机收到一个数据包后，数据包先在内核空间中处理，若发现目的地址是自身，则传到用户空间中交给对应的应用程序处理，若发现目的不是自身，则会将包丢弃或进行转发。</p>
<p>2、iptables实现防火墙功能的原理是：在数据包经过内核的过程中有五处关键地方，分别是<strong>PREROUTING、INPUT、OUTPUT、FORWARD、POSTROUTING</strong>，用户可以在这五条链上编写 Rules，对经过的数据包进行处理，规则一般的定义为“如果数据包头符合这样的条件，就这样处理数据包”。</p>
<p>3、iptables中定义有5条链，每条链中可以定义多条 Rules，每当数据包到达一条链时，iptables就会从链上第一条规则开始匹配，看该数据包是否满足规则所定义的条件。如果满足，系统就会根据该条规则所定义的规则逻辑（称为 target）处理该数据包；否则 iptables 将继续检查下一条规则，如果该数据包不符合链中任一条规则，iptables就会根据预先定义的默认策略来处理数据包；</p>
<p>4、iptables中定义有表，分别表示提供的功能，有filter表（实现包过滤）、nat表（实现网络地址转换）、mangle表（实现包修改）、raw表（实现数据跟踪），这些表具有一定的优先级：<strong>raw&ndash;&gt;mangle&ndash;&gt;nat&ndash;&gt;filter</strong></p>
<h2 id="参考">参考</h2>
<ul>
<li>
<p><a href="https://www.cnblogs.com/liang2580/articles/8400140.html">https://www.cnblogs.com/liang2580/articles/8400140.html</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/qq_29344757/article/details/81128150">https://blog.csdn.net/qq_29344757/article/details/81128150</a></p>
</li>
<li>
<p><a href="http://www.zsythink.net/archives/1199">http://www.zsythink.net/archives/1199</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/u011537073/article/details/82685586">https://blog.csdn.net/u011537073/article/details/82685586</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/longbei9029/article/details/53056744">https://blog.csdn.net/longbei9029/article/details/53056744</a></p>
</li>
</ul>

        </div>

        

        
<br>
<div class="heading">Tags:</div>
<div class="field is-grouped is-grouped-multiline">
  <div class="control">
    <a href="/tags/kubernetes">
      <span class="tag">Kubernetes</span>
    </a>
  </div>
</div>

      </div>

    </section>

    <section class="section">

      
      <script src="https://utteranc.es/client.js"
        repo = "yingchi1994/HugoComments"
        issue-term = "pathname"
        theme = "github-light"
        crossorigin="anonymous"
        async>
      </script>
      <br>
      
      
      <div class="container">
  <div class="level">

    <div class="level-left">
      <div class="level-item">
        <p class="control has-addons">
          <a class="button" href="https://blog.yingchi.io/posts/2020/5/client-go.html">
            <span class="icon is-small"><i class="fa fa-chevron-left"></i></span>
            <span class="is-hidden-touch is-hidden-desktop-only">
              client-go 初步认识与实践
            </span>
            <span class="is-hidden-touch is-hidden-widescreen">
              client-go 初步认识与实践
            </span>
            <span class="is-hidden-mobile is-hidden-desktop">
              client-go 初步认识与实践
            </span>
            <span class="is-hidden-tablet">
              client-go 初步认识与实践
            </span>
            
          </a>
        </p>
      </div>
    </div>

    <div class="level-right">
      <div class="level-item">
        <p class="control has-addons">
          <a class="button" href="https://blog.yingchi.io/posts/2020/4/docker-k8s-network-3.html">
            <span class="is-hidden-touch is-hidden-desktop-only">
              Kubernetes &amp; Docker 网络原理（三）
            </span>
            <span class="is-hidden-touch is-hidden-widescreen">
              Kubernetes &amp; Docker 网络原理（三）
            </span>
            <span class="is-hidden-mobile is-hidden-desktop">
              Kubernetes &amp; Docker 网络原理（三）
            </span>
            <span class="is-hidden-tablet">
              Kubernetes &amp; Docker 网络原理（三）
            </span>
            
            <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
          </a>
        </p>
      </div>
    </div>

  </div>
</div>


      <br>

      
      

      <br>
      
      
      
<div class="container">
  <nav class="panel">
    <p class="panel-heading">Related</p>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/docker-k8s-network-3.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>Kubernetes &amp; Docker 网络原理（三）&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/docker-k8s-network-2.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>Kubernetes &amp; Docker 网络原理（二）&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/docker-k8s-network-1.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>Kubernetes &amp; Docker 网络原理（一）&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/kubernetes-resources.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>理解 Kubernetes 的 Resource 设计概念&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/kubernetes-arch.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>Kubernetes 架构浅析&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/kubernetes-rolling-update.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>Kubernetes Rolling Update 滚动升级&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2020/4/kubeadm-flannel-mannul.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>记一次 Kubeadm 部署 k8s &#43; Flannel&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
    <a class="panel-block" href="https://blog.yingchi.io/posts/2019/10/network-devices.html">
      <span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
      <span>&nbsp;</span>
      <span>网络模型学习基础：各层网络设备概念&nbsp;
      <div class="tag">Kubernetes</div>
      </span>
    </a>
  </nav>
</div>

    </section>

    <footer class="footer" 
style="text-align: center; background-color: #ffffff;">
  <div class="container">
    <span style="font-size: small;">
      <a href="https://yingchi.io/">yingchi.io</a>
       © 2018-2020</span>
    <span style="font-size: small;"> Joey.Jiang | 
      <a href="https://gohugo.io/" style="text-decoration: none; color: rgb(61, 71, 131);">Hugo</a></span>
  </div>
</footer>

  </body>

</html>
<style>

body {
  max-width: 1160px;
  margin: 0 auto;
}

.container{
  width: 800px;
}

.title-custom {
  text-align: center;
  margin-bottom: 10px;
  font-size: 30px;
  font-weight: bold;
}

.subtitle-custom {
  text-align: center;
  margin-bottom: 20px;
  font-size: 18px;
}

.content-custom {
    color: #000;
    font-size: 16px;
}

.content-custom blockquote {
    margin-bottom: 15px;
    padding: 15px 0 15px 25px;
    background: rgb(245, 246, 247);
    border-left: 10px solid rgb(229, 232, 236);
    border-radius: 5px;
}

.content-custom strong {
    color: rgb(91, 127, 194);
}

.content-custom em {
    font-style: normal;
    font-weight: bold;
}

.content-custom p {
    margin: 0 10px;
}

.content-custom ul{
    margin: 25px;
    padding: 10px 0;
    background: rgb(245, 246, 247);
    border-radius: 5px;
    list-style-type: square;
}

.content-custom ul ul{
    margin: 0px;
    list-style-type: circle;
    padding: 0;
}

.content-custom ol{
    margin: 25px;
    padding: 10px 0;
    background: rgb(245, 246, 247);
    border-radius: 5px;
}

.content-custom li {
    margin: 5px 40px;
}

.content-custom img {
    margin: 20px auto !important;
    text-align: center;
    clear: both;
    display: block;
    margin: auto;
    width: 80%;
}



.content-custom pre{
    color: rgb(224, 235, 247);
    margin: 10px;
    padding: 10px 20px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgb(85, 94, 104);
    background-color: rgb(85, 94, 104) !important;
}

.content-custom h1 {
    font-size: 25px;
    font-weight: bold;
    margin: 20px 0 10px 0;
    padding: 15px;
     
    border-bottom: 3px solid #555;
}
.content-custom h2 {
    font-size: 20px;
    font-weight: bold;
    margin: 40px 0 20px 0;
    padding: 10px;
     
    border-bottom: 2px solid #555;
}
.content-custom h3 {
    font-size: 18px;
    font-weight: bold;
    margin: 16px 0 10px 0;
    padding: 10px;
     
     
}
.content-custom h4 {
    font-size: 16px;
    font-weight: bold;
    margin: 10px 0 10px 0;
    padding: 10px;
     
     
}

 
@media screen and (max-width: 960px){

  body{
    overflow-x: hidden;
  }

  .container{
    width: 100%;
  }

  .content-custom img {
    width: 100%;
  }

  .title-custom {
    font-size: 22px;
  }
}


</style>
